# Firebase Database Setup for Obscura

This document explains the Firebase database setup for storing generated game content including stories, clues, case intros, and maps.

## Overview

The Firebase database is configured to store complete case data for each user, including:
- **Story Structure**: Victim, suspects, timeline, locations
- **Case Intro**: Narrative and journal entries
- **Clues**: Processed clues with discovery requirements
- **Map**: Location nodes and connections
- **Map Images**: Generated map images stored in Cloudinary
- **Metadata**: Title, difficulty, tags, status, timestamps

## Database Structure

### Collections

#### `users`
- Stores user profile data and statistics
- Document ID: User UID from Firebase Auth
- Fields: name, email, role, stats, profile, etc.

#### `cases`
- Stores all generated cases
- Document ID: Auto-generated by Firestore
- Fields: userId, title, story, caseIntro, clues, map, mapImageUrl, mapImagePublicId, status, etc.

### Case Data Interface

```typescript
interface CaseData {
  id?: string;
  userId: string;
  title: string;
  story: StoryStructure;
  caseIntro: CaseIntro;
  clues: ProcessedClues;
  map: MapStructure;
  mapImageUrl?: string;
  mapImagePublicId?: string; // Cloudinary public ID for deletion
  status: 'active' | 'completed' | 'archived';
  createdAt: any;
  updatedAt: any;
  completedAt?: any;
  difficulty: 'easy' | 'medium' | 'hard';
  estimatedDuration: number;
  tags: string[];
}
```

## Setup Instructions

### 1. Environment Variables

Create a `.env.local` file in the `client` directory with your Firebase and Cloudinary configuration:

```env
# Firebase Configuration
NEXT_PUBLIC_FIREBASE_API_KEY=your-api-key
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=your-project.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=your-project-id
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=your-project.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=123456789
NEXT_PUBLIC_FIREBASE_APP_ID=your-app-id

# Cloudinary Configuration
CLOUDINARY_CLOUD_NAME=your-cloud-name
CLOUDINARY_API_KEY=your-api-key
CLOUDINARY_API_SECRET=your-api-secret
```

### 2. Firebase Console Setup

1. Go to [Firebase Console](https://console.firebase.google.com/)
2. Create a new project or select existing one
3. Enable Authentication (Email/Password)
4. Enable Firestore Database
5. Set up Firestore security rules (see below)

### 3. Cloudinary Setup

1. Go to [Cloudinary Console](https://cloudinary.com/console)
2. Create a new account or sign in
3. Get your cloud name, API key, and API secret
4. Add them to your `.env.local` file

### 4. Firestore Security Rules

Add these security rules to your Firestore database:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can only access their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Users can only access their own cases
    match /cases/{caseId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
    }
  }
}
```

## Usage

### Database Operations

The database operations are available through the following files:

#### `lib/gameDb.ts`
Core database functions:
- `createCase()` - Create a new case
- `getCase()` - Get a specific case
- `getUserCases()` - Get all cases for a user
- `updateCase()` - Update a case
- `deleteCase()` - Delete a case
- `deleteCaseWithImage()` - Delete case and its map image
- `completeCase()` - Mark case as completed
- `searchCases()` - Search cases by title/tags
- `getUserCaseStats()` - Get user statistics

#### `lib/cloudinary.ts`
Cloudinary image management:
- `uploadImageFromArrayBuffer()` - Upload image from ArrayBuffer
- `deleteImageFromCloudinary()` - Delete image from Cloudinary
- `generateMapFileName()` - Generate unique map filenames

#### `lib/caseGenerator.ts`
Helper functions for case generation and storage:
- `generateAndStoreCase()` - Generate and store complete case
- `generateCaseTitle()` - Auto-generate case title
- `estimateCaseDuration()` - Calculate estimated play time
- `generateCaseTags()` - Generate tags from case content

#### `hooks/useCases.ts`
React hook for case management:
- `useCases()` - Provides all case operations with loading states

### API Endpoints

#### `POST /api/initCase`
Creates a new case with generated content and map image:

```typescript
// Request body
{
  userId: string;
  difficulty?: 'easy' | 'medium' | 'hard';
  theme?: string;
  setting?: string;
  customTitle?: string;
}

// Response
{
  success: boolean;
  caseId: string;
  title: string;
  estimatedDuration: number;
  tags: string[];
  mapImageUrl?: string;
}
```

### Example Usage

#### Creating a New Case with Map Image

```typescript
import { useCases } from '@/hooks/useCases';

function NewCaseComponent() {
  const { createNewCase, loading } = useCases();
  
  const handleCreateCase = async () => {
    const result = await createNewCase({
      userId: 'user123',
      title: 'The Mysterious Disappearance',
      story: { /* story data */ },
      caseIntro: { /* intro data */ },
      clues: { /* clues data */ },
      map: { /* map data */ },
      mapImageUrl: 'https://res.cloudinary.com/...',
      mapImagePublicId: 'obscura/maps/map_123_456',
      status: 'active',
      difficulty: 'medium',
      estimatedDuration: 45,
      tags: ['mystery', 'detective']
    });
    
    if (result.caseId) {
      console.log('Case created with map image:', result.caseId);
    }
  };
}
```

#### Deleting a Case with Map Image

```typescript
import { useCases } from '@/hooks/useCases';

function CaseList() {
  const { deleteExistingCaseWithImage } = useCases();
  
  const handleDeleteCase = async (caseId: string) => {
    const result = await deleteExistingCaseWithImage(caseId);
    if (!result.error) {
      console.log('Case and map image deleted successfully');
    }
  };
}
```

## Map Image Handling

### Upload Process

1. **Generation**: Map image is generated as an ArrayBuffer
2. **Conversion**: ArrayBuffer is converted to base64 data URI
3. **Upload**: Image is uploaded to Cloudinary with optimized settings
4. **Storage**: URL and public ID are stored in Firebase

### File Organization

- **Folder**: `obscura/maps/`
- **Naming**: `map_{caseId}_{timestamp}`
- **Format**: PNG with auto-optimization
- **Quality**: Auto-optimized for web delivery

### Cleanup

When a case is deleted:
1. Map image is deleted from Cloudinary using the stored public ID
2. Case document is deleted from Firestore
3. Both operations are handled atomically

## Integration with Generation Functions

To integrate with your existing generation functions, update the API route:

```typescript
// In /api/initCase/route.ts
import { generateStory } from '@/functions/storyGenerator';
import { composeCaseIntro } from '@/functions/caseIntroComposer';
import { generateGameClues } from '@/functions/clueGenerator';
import { generateLocationMap } from '@/functions/mapGenerator';

// Generate content
const story = await generateStory();
const caseIntro = await composeCaseIntro(story);
const clues = await generateGameClues(story);
const map = await generateLocationMap(story);

// Handle map image
const mapImage = await map.mapImage.arrayBuffer();
const uploadResult = await uploadImageFromArrayBuffer(mapImage);
```

## Error Handling

All database functions return consistent error objects:

```typescript
// Success case
{ caseId: "abc123", error: null }

// Error case
{ caseId: null, error: "Failed to create case" }
```

## Performance Considerations

- Map images are optimized for web delivery
- Cloudinary provides automatic format optimization
- Images are stored in a dedicated folder structure
- Deletion operations clean up both database and storage

## Security Notes

- All database operations require user authentication
- Users can only access their own cases
- Map images are stored with unique, non-guessable filenames
- Cloudinary provides secure, CDN-delivered images

## Troubleshooting

### Common Issues

1. **Firebase not initialized**: Check environment variables
2. **Cloudinary upload fails**: Verify API credentials
3. **Permission denied**: Verify Firestore security rules
4. **Type errors**: Ensure all interfaces match the database schema

### Debug Mode

Enable debug logging by setting:

```typescript
// In firebase.ts
if (process.env.NODE_ENV === 'development') {
  console.log('Firebase config:', firebaseConfig);
}

// In cloudinary.ts
console.log('Uploading image to Cloudinary...');
``` 